---
title: "Troubleshooting"
author: "Jonah Gabry and Ben Goodrich"
date: "10/11/2015"
output: 
  html_document: 
    fig_caption: yes
    toc: yes
---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{How to Use the rstanarm Package}
-->

```{r, SETTINGS-knitr, include=FALSE}
library(knitr)
opts_chunk$set(dev = 'svg', fig.height = 1.5, fig.width = 2.5,
               fig.align='center', message = FALSE, warning = FALSE) 
```

```{r, SETTINGS-gg, include=FALSE}
library(rstanarm)
rstan_ggtheme_options(axis.text.x = element_text(size = 8),
                      axis.title.x = element_text(size = 10),
                      axis.line.x = element_line(size = 1))
```

----
This vignette provides suggestions for how to proceed when you encounter 
warning messages generated by the modeling functions in the __rstanarm__ package.


### Markov chains did not converge

__Recommendation:__ try running the chains for more iterations. <br>

By default, all __rstanarm__ modeling functions will run four randomly
initialized Markov chains, each for 2000 iterations (including a warmup period
of 1000 iterations). All chains must converge to the target distribution for
inferences to be valid. For most models the default settings are sufficient, but
if you get a warning message about Markov chains not converging the first thing
to try is increasing the number of iterations. This can be done by specifying
the `iter` argument (e.g. `iter = 3000`).

<br> _More Details_ <br>

One way to monitor whether a chain has converged to the equilibrium distribution
is to compare its behavior to other randomly initialized chains. This is the
motivation for the Gelman and Rubin potential scale reduction statistic Rhat.
The Rhat statistic measures the ratio of the average variance of the draws within
each chain to the variance of the pooled draws across chains; if all chains
are at equilibrium, these will be the same and Rhat will be one. If the chains
have not converged to a common distribution, the Rhat statistic will be greater
than one. (Details on the computatation of Rhat and some of its limitations can be 
found in the 'Markov Chain Monte Carlo Sampling' chapter of the [Stan Modeling
Language User's Guide and Reference Manual](http://mc-stan.org/documentation/).)

Gelman and Rubin’s recommendation is that the independent Markov chains be 
initialized with diffuse starting values for the parameters and sampled until 
all values for Rhat are below 1.1. When any Rhat values are above 1.1
__rstanarm__ will print a warning message like this:

    Markov chains did not converge! Do not analyze results! 

To illustrate how to check the Rhat values after fitting a model using
__rstanarm__ we'll fit two models and run them for different numbers of
iterations. This is just for the purposes of demonstrating some useful
functions, so we won't pay attention to the models themselves, just the
Rhat values.

```{r, FIT, results='hide', warning=TRUE}
SEED <- 12345
bad_rhat <- stan_glmer(mpg ~ wt + (1|cyl) + (1|gear), data = mtcars, 
                       iter = 100, seed = SEED)
good_rhat <- update(bad_rhat, iter = 500, seed = SEED)
```

Here the first model leads to the warning message about convergence but the 
second model does not. To see a histogram of the Rhat values we can use the 
`stan_rhat` function, which can be called directly or using the `plot` method
for `stanreg` objects:

```{r, Rhat-plot}
stan_rhat(bad_rhat) # or plot(bad_rhat, fun = "stan_rhat")
```

Indeed, we can see that not all Rhat values are less than 1.1. The Rhat values
for all parameters are returned by the `summary` function (e.g. `summary(bad_rhat)`). 
Checking only the parameters with an Rhat value above 1.1 can be done like this:

```{r, Rhat-summary}
rhat <- summary(bad_rhat)[, "Rhat"]
rhat[rhat > 1.1]
```

Since we didn't get a warning for the second model we shouldn't find any 
parameters with an Rhat greater than 1.1:

```{r, Rhat-summary-good}
any(summary(good_rhat)[, "Rhat"] > 1.1)
```

__References__

Gelman, A., & Rubin, D. B. (1992). Inference from iterative simulation using
multiple sequences. _Statistical Science_, 7(4), 457–472.

Stan Development Team. (2015). _Stan modeling language user's guide and reference
manual, Version 2.8.0_. http://mc-stan.org/documentation


